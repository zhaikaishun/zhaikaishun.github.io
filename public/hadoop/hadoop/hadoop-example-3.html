<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>Hadoop入门案例（三）全排序之自定义分区 数字排序 | 挡路人</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="Jelon, 前端, Web, 张德龙, 前端开发" >
    <meta name="description" content="Jelon个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="挡路人" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fd459238242776d173cdc64918fb32f2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


</head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">挡路人</span>
                    <span class="description">学有所思，思有所感</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/hadoop/hadoop/hadoop-example-3.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/hadoop/hadoop/hadoop-example-3.html" class="item ">
                <a href="/lab/" title="实验室" class="icon-lab">&nbsp;实验室</a>
            </li>
            
            <li rel="/hadoop/hadoop/hadoop-example-3.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/hadoop/hadoop/hadoop-example-3.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/jangdelong" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/jangdelong" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>Hadoop入门案例（三）全排序之自定义分区 数字排序</span></h3>
    </header>
    <p class="post-meta text-center">
        kaishun 发表于
        <time datetime="2016-07-25T13:25:21.000Z">2016-07-25</time>
    </p>
    <div class="post-content">
	<!-- Table of Contents -->

        <h2 id="需求介绍"><a href="#需求介绍" class="headerlink" title="需求介绍"></a><strong>需求介绍</strong></h2><p>大量的文本中有大量数字，需要对数字进行全排序,按照升序排序  </p>
<h2 id="测试的文本"><a href="#测试的文本" class="headerlink" title="测试的文本"></a><strong>测试的文本</strong></h2><pre><code>145 
95 167 84 6 120 164 195 81 35 63 1 11 89 170 55 
58 88 125 173 2 173 129 74 69 24 107 55 149 83 178 
159 147 178 53 137 53 132 134 154 174 164 122 108 130 184 
28 129 93 157 171 127 192 86 194 41 111 114 190 98 99 
99 5 161 146 120 122 80 1 66 171 47 54 121 130 170 
125 119 8 52 182 112 146 1 198 0 149 72 56 191 48 
172 165 49 73 107 134 179 0 59 16 143 83 92 113 152 
109 118 186 186 97 117 193 67 34 152 92 179 52 51 26 
163 121 115 72 17 61 107 125 115 163 18 76 2 172 39 
190 184 73 108 7 142 68 54 60 169 71 28 141 48 139 
182 140 158 102 99 36 158 55 190 176 45 63 126 179 130 
95 22 120 109 59 78 38 13 5 88 1 87 184 83 198 
47 73 82 94 141 190 184 161 56 141 99 177 107 21 158 
71 149 61 137
</code></pre><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a><strong>原理分析</strong></h2><p>利用mapReduce中map到reduce端的shuffle进行排序，MapReduce只能保证各个分区内部有序，但不能保证全局有序，于是我还自定义了分区，在map后、shuffle之前，我先将小于50的放在0分区，50-100的放在1分区，100到150的放在2分区，其余的放在三分区，这样，首先保证了分区与分区之间是整体有序，然后各个分区进行各自的shuffle，使其分区内部有序</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a><strong>代码</strong></h2><pre><code class="java"><span class="keyword">package</span> com.myhadoop.mapreduce.test;

<span class="keyword">import</span> org.apache.hadoop.conf.Configured;
<span class="keyword">import</span> org.apache.hadoop.fs.Path;
<span class="keyword">import</span> org.apache.hadoop.io.IntWritable;
<span class="keyword">import</span> org.apache.hadoop.io.LongWritable;
<span class="keyword">import</span> org.apache.hadoop.io.Text;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.Partitioner;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
<span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
<span class="keyword">import</span> org.apache.hadoop.util.Tool;
<span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;

<span class="keyword">import</span> java.io.IOException;

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TotalSort</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span></span>{

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">IntWritable</span>&gt;</span>
<span class="class">    </span>{
        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key,Text value,Context context)</span> <span class="keyword">throws</span> IOException,InterruptedException</span>
<span class="function">        </span>{
            String[] split = value.toString().split(<span class="string">"\\s+"</span>);
            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;split.length ; i++) {
                <span class="keyword">try</span>{
                    IntWritable intWritable = <span class="keyword">new</span> IntWritable(Integer.parseInt(split[i]));
                    context.write(intWritable, intWritable);
                }<span class="keyword">catch</span> (Exception e){
                    e.printStackTrace();
                }
            }


        }
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">IntWritable</span>, <span class="title">IntWritable</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>&gt;</span>
<span class="class">    </span>{
        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(IntWritable key,Iterable&lt;IntWritable&gt; values,Context context)</span> <span class="keyword">throws</span> IOException,InterruptedException</span>
<span class="function">        </span>{
            <span class="keyword">for</span> (IntWritable value:values) {
                context.write(value, <span class="keyword">new</span> Text(<span class="string">""</span>));
            }
        }
    }

    <span class="comment">/*</span>
<span class="comment">    ·* 重写Partition的方法</span>
<span class="comment">     */</span>
    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Partition</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">IntWritable</span>, <span class="title">IntWritable</span>&gt;</span>{
        <span class="meta">@Override</span>
        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(IntWritable key, IntWritable intWritable2, <span class="keyword">int</span> i)</span> </span>{
            <span class="keyword">int</span> i1=key.get();
            <span class="keyword">if</span>(i1&lt;<span class="number">50</span>){
                <span class="keyword">return</span> <span class="number">0</span>;
            }<span class="keyword">else</span> <span class="keyword">if</span>(i1&lt;<span class="number">100</span>){
                <span class="keyword">return</span> <span class="number">1</span>;
            }<span class="keyword">else</span> <span class="keyword">if</span>(i1&lt;<span class="number">150</span>){
                <span class="keyword">return</span> <span class="number">2</span>;
            }
            <span class="keyword">return</span> <span class="number">3</span>;

        }
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{
        Job job = Job.getInstance(getConf());
        job.setJarByClass(TotalSort.class);
        job.setJobName(<span class="string">"TotalSort"</span>);

        job.setOutputKeyClass(IntWritable.class);
        job.setOutputValueClass(IntWritable.class);

        job.setPartitionerClass(Partition.class);
        job.setMapperClass(Map.class);
        job.setReducerClass(Reduce.class);
        job.setNumReduceTasks(<span class="number">4</span>);

        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));
        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));

        <span class="keyword">boolean</span> success = job.waitForCompletion(<span class="keyword">true</span>);
        <span class="keyword">return</span> success ? <span class="number">0</span>:<span class="number">1</span>;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{
        <span class="keyword">int</span> ret = ToolRunner.run(<span class="keyword">new</span> TotalSort(), args);
        System.exit(ret);
    }
}
</code></pre>
<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a><strong>运行结果</strong></h2><p>生成了4个文件，part-r-00000，part-r-00001，part-r-00002，part-r-00003，这四个文件内部都有序<br>part-r-00000内的元素都小于part-r00001的元素，其他的以此类推  </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>利用自定义分区，保证整体有序，利用mapreduce内部的shuffle，对key进行排序，保证了局部有序，从而实现了全排序</p>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/hadoop/">大数据</a>|<a class="cat-link" href="/categories/hadoop/hadoop/">hadoop</a>
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/hadoop/" title="hadoop">hadoop</a>
    

        </span>
    </p>
</article>
<!-- 分享按钮 -->

  <div class="article-share clearfix text-center">
    <div class="share-area">
      <span class="share-txt">分享到：</span>
      <a href="javascript: window.open('http://service.weibo.com/share/share.php?url=' + encodeURIComponent(location.href) + '&title=' + document.title + '&language=zh_cn');" class="share-icon weibo"></a>
      <a href="javascript: alert('请复制链接到微信并发送');" class="share-icon wechat"></a>
      <a href="javascript: window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=' + encodeURIComponent(location.href) + '&title=' + document.title);" class="share-icon qqzone"></a>
      <a href="javascript: window.open('http://connect.qq.com/widget/shareqq/index.html?url=' + encodeURIComponent(location.href) + '&desc=Jelon个人博客&title=' + document.title + '&callback=' + encodeURIComponent(location.href));" class="share-icon qq"></a>
      <a href="javascript: window.open('http://shuo.douban.com/!service/share?href=' + encodeURIComponent(location.href) + '&name=' + document.title + '&text=' + document.title);" class="share-icon douban"></a>
    </div>
  </div>


<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br >
        <a href="/hadoop/hadoop/hadoop-example-4.html">
            
                Hadoop入门案例（四）全排序之自定义分区 字符串（单词）排序
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br >
        <a href="/hadoop/hadoop/hadoop-example-2.html">
            
                Hadoop入门案例（二） 单词去重
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

  <script src="/js/comment.js"></script>
  <div id="comments" class="comment">
    <!--
    <div class="sign-bar">
      GitHub 已登录!
      <span class="sign-link">登出</span>
    </div>
    <section class="box">
      <div class="com-avatar"><img src="/img/jelon.jpg" alt="avatar"></div>
      <div class="com-text">
        <div class="main">
          <textarea class="text-area-edited show" placeholder="欢迎评论！"></textarea>
          <div class="text-area-preview"></div>
        </div>
        <div class="switch">
          <div class="switch-item on">编辑</div>
          <div class="switch-item">预览</div>
        </div>
        <div class="button">提交</div>
      </div>
    </section>
    <section class="tips">注：评论支持 markdown 语法！</section>
    <section class="list-wrap">
      <ul class="list">
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">张德龙</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like liked">已赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">333333</div>
          </div>
        </li>
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">刘德华</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like">点赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">vvvvv</div>
          </div>
        </li>
      </ul>
      <div class="page-nav">
        <a href="javascript: void(0);" class="item">1</a>
        <a href="javascript: void(0);" class="item">2</a>
        <a href="javascript: void(0);" class="item current">3</a>
      </div>
    </section>
    -->
  </div>
  <script>
  JELON.Comment({
    container: 'comments',
    label: 'hadoop-example-3' || 'hadoop/hadoop/hadoop-example-3.html',
    owner: 'jangdelong',
    repo: 'blog_comments',
    clientId: 'b08ed25e52c57993e69c',
    clientSecret: '1cb9545488f0380904b87350e7c5a270ae03bab7'
  });
  </script>


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/hadoop/">大数据</a>
        <span class="badge">(40)</span>
    </li>
    
    <li>
        <a href="/categories/hadoop/hdfs/">hdfs</a>
        <span class="badge">(8)</span>
    </li>
    
    <li>
        <a href="/categories/hadoop/hadoop/">hadoop</a>
        <span class="badge">(9)</span>
    </li>
    
    <li>
        <a href="/categories/programme/">programme</a>
        <span class="badge">(10)</span>
    </li>
    
    <li>
        <a href="/categories/Linux/">Linux</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/架构/">架构</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="/categories/hadoop/spark/">spark</a>
        <span class="badge">(22)</span>
    </li>
    
    <li>
        <a href="/categories/随笔/">随笔</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/算法/">算法</a>
        <span class="badge">(2)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/hdfs/" title="hdfs">hdfs (8)</a>
  
    <a class="tag-item" href="/tags/hadoop/" title="hadoop">hadoop (9)</a>
  
    <a class="tag-item" href="/tags/java/" title="java">java (8)</a>
  
    <a class="tag-item" href="/tags/JDBC/" title="JDBC">JDBC (1)</a>
  
    <a class="tag-item" href="/tags/工具类/" title="工具类">工具类 (1)</a>
  
    <a class="tag-item" href="/tags/linux/" title="linux">linux (2)</a>
  
    <a class="tag-item" href="/tags/crontab/" title="crontab">crontab (1)</a>
  
    <a class="tag-item" href="/tags/Netty/" title="Netty">Netty (1)</a>
  
    <a class="tag-item" href="/tags/spark/" title="spark">spark (22)</a>
  
    <a class="tag-item" href="/tags/netty/" title="netty">netty (1)</a>
  
    <a class="tag-item" href="/tags/hive/" title="hive">hive (1)</a>
  
    <a class="tag-item" href="/tags/大数据/" title="大数据">大数据 (1)</a>
  
    <a class="tag-item" href="/tags/曲线拟合/" title="曲线拟合">曲线拟合 (1)</a>
  
    <a class="tag-item" href="/tags/io/" title="io">io (1)</a>
  
    <a class="tag-item" href="/tags/scala/" title="scala">scala (3)</a>
  
    <a class="tag-item" href="/tags/随笔/" title="随笔">随笔 (2)</a>
  
    <a class="tag-item" href="/tags/剑指向offer/" title="剑指向offer">剑指向offer (1)</a>
  
    <a class="tag-item" href="/tags/算法/" title="算法">算法 (2)</a>
  
    <a class="tag-item" href="/tags/笔试题/" title="笔试题">笔试题 (1)</a>
  
    <a class="tag-item" href="/tags/动态规划/" title="动态规划">动态规划 (1)</a>
  
    <a class="tag-item" href="/tags/数学/" title="数学">数学 (1)</a>
  
    <a class="tag-item" href="/tags/Exception/" title="Exception">Exception (1)</a>
  
    <a class="tag-item" href="/tags/xml解析/" title="xml解析">xml解析 (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="http://blog.sina.com.cn/u/1825875765" target="_blank" title="网络安全博客">Haoren博客</a>
        </li>
    
        <li>
            <a href="http://blog.csdn.net/yeweiouyang" target="_blank" title="技术博客">Maxwell博客</a>
        </li>
    
        <li>
            <a href="http://xuanzh.cc/" target="_blank" title="技术博客">朱旋个人博客</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2018
    

    <a href="/">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>
</body>
</html>